<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Payment </title>
    <link rel="icon" type="image/avif" href="images/logo.avif">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        line-height: 1.4;
    }

    .no-print-top {
        margin: 20px auto;
        width: 160mm;
        text-align: left;
    }

    .receipt-container {
        width: 160mm;
        height: auto;
        min-height: 290mm;
        margin: 20px auto;
        padding: 15px;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        font-size: 0.75rem;
    }

    .header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-bottom: 10px;
        margin-bottom: 10px;
        border-bottom: 1px solid #e2e8f0;
        text-align: center;
        page-break-after: avoid;
        min-height: 100px; /* Maintains the approximate space of the original header */
    }

    .receipt-title-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
    }

    .receipt-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        flex: 1;
        text-align: center;
    }

    .billing-date, .invoice-number {
        font-size: 0.75rem;
        color: #64748b;
    }

    .invoice-number {
        text-align: right;
    }

    .details-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 8px;
        margin-bottom: 10px;
        page-break-inside: auto;
    }

    .details-grid p {
        padding: 6px 0;
        font-size: 0.75rem;
    }

    .details-grid strong {
        font-weight: 600;
        color: #1e293b;
    }

    .payment-summary {
        margin-top: 10px;
        page-break-inside: avoid;
    }

    .payment-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 0.75rem;
    }

    .payment-row.total {
        font-weight: 600;
        border-top: 1px dashed #cbd5e1;
        border-bottom: 1px solid #cbd5e1;
        margin: 8px 0;
    }

    .payment-row.pending {
        font-weight: 600;
        border-bottom: 2px double #1e293b;
        padding-bottom: 8px;
    }

    .payment-row span:last-child {
        text-align: right;
        min-width: 100px;
    }

    .signature-section {
        display: flex;
        justify-content: space-between;
        margin: 15px 0;
        padding-top: 10px;
        border-top: 1px solid #e2e8f0;
        align-items: flex-end;
        page-break-before: avoid;
    }

    .signature-box {
        width: 48%;
        display: flex;
        flex-direction: column;
        height: 80px;
    }

    .signature-box p {
        margin-bottom: 20px;
    }

    .signature-line {
        margin-top: auto;
        border-top: 1px dashed #64748b;
        padding-top: 4px;
        font-size: 0.7rem;
        color: #64748b;
        text-align: center;
    }

    .footer {
        text-align: center;
        color: #64748b;
        font-size: 0.7rem;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e2e8f0;
        page-break-before: auto;
    }

    .footer ul {
        list-style-type: none;
        text-align: left;
        margin: 8px 0;
    }

    .footer ul li {
        margin-bottom: 4px;
    }

    .thank-you {
        font-family: 'Dancing Script', cursive;
        font-size: 1.2rem;
        color: #000000;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        margin: 10px 0;
    }

    .previous-payments {
        margin-top: 10px;
        border-top: 1px solid #e2e8f0;
        padding-top: 10px;
        page-break-inside: auto;
    }

    .previous-payments h3 {
        font-size: 0.85rem;
        color: #1e293b;
        margin-bottom: 8px;
    }

    .payment-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px dashed #e2e8f0;
        font-size: 0.75rem;
    }

    .payment-item:last-child {
        border-bottom: none;
    }

    .no-print {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
    }

    .input-group {
        margin-bottom: 10px;
        display: none;
    }

    #bookingIdGroup {
        display: block;
    }

    label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: #1e293b;
        font-size: 0.75rem;
    }

    input, select {
        width: 100%;
        padding: 8px;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        font-size: 0.75rem;
    }

    input:focus, select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }

    .payment-inputs {
        display: flex;
        gap: 8px;
    }

    .payment-inputs select,
    .payment-inputs input {
        flex: 1;
    }

    .readonly-input {
        background-color: #f1f5f9;
        cursor: not-allowed;
    }

    .button-group {
        display: flex;
        gap: 8px;
        margin-top: 15px;
    }

    button {
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.75rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
    }

    button:hover:not(:disabled) {
        transform: translateY(-1px);
    }

    #searchButton {
        background-color: #6366f1;
        color: white;
    }

    #searchButton:hover:not(:disabled) {
        background-color: #4f46e5;
    }

    #saveButton {
        background-color: #10b981;
        color: white;
    }

    #saveButton:hover:not(:disabled) {
        background-color: #059669;
    }

    #printButton {
        background-color: #3b82f6;
        color: white;
    }

    #printButton:hover:not(:disabled) {
        background-color: #2563eb;
    }

    #backButton {
        background-color: #6b7280;
        color: white;
    }

    #backButton:hover:not(:disabled) {
        background-color: #4b5563;
    }

    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .error-message {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 0.75rem;
        display: none;
    }

    .error-message.error {
        background-color: #fee2e2;
        color: #dc2626;
        border: 1px solid #f5a5a5;
    }

    .error-message.success {
        background-color: #dcfce7;
        color: #16a34a;
        border: 1px solid #86efac;
    }

    @media print {
        .footer ul {
            list-style-type: disc;
            padding-left: 15px;
        }

        .header {
            align-items: center;
            min-height: 100px; /* Maintains space in print */
        }

        .no-print, .no-print-top {
            display: none !important;
        }

        body {
            background: none;
            margin: 0;
            padding: 0;
        }

        .receipt-container {
            box-shadow: none;
            border: none;
            width: 160mm;
            height: auto;
            min-height: 290mm;
            padding: 10mm;
            margin: 0;
            overflow: visible;
            page-break-after: auto;
        }

        .details-grid, .payment-summary, .footer {
            page-break-inside: auto;
        }

        .header, .signature-section {
            page-break-inside: avoid;
        }

        .receipt-container:last-child {
            page-break-after: avoid;
        }

        @page {
            size: 160mm auto;
            margin: 0;
        }
    }
    </style>
</head>
<body>
    <div class="no-print-top">
        <button id="backButton">Back</button>
    </div>
    
    <div class="receipt-container">
        <div class="header">
            <!-- Header content removed but space preserved -->
        </div>

        <div class="receipt-title-section">
            <span class="billing-date" id="billingDate"></span>
            <h2 class="receipt-title">PAYMENT RECEIPT</h2>
            <span class="invoice-number" id="invoiceNumber"></span>
        </div>

        <div id="details" class="details-grid">
            <!-- Details will be populated here -->
        </div>

        <div id="paymentSection">
            <!-- Payment summary will be added here -->
        </div>

        <div class="footer">
            <p>Special Instructions</p>
            <ul>
                <li>You are liable for any damage to hotel property or event materials; charges apply as per current market value.</li>
                <li>Food menu must be finalized at least 14 days before the event; otherwise, the booking will be automatically canceled.</li>
                <li>All payments are non-refundable and non-transferable.</li>
                <li>A 10% service charge and applicable government taxes apply; prices may vary with market rates or tax changes.</li>
                <li>Rescheduling may incur additional taxes; full advance payment is required within 14 days of booking.</li>
            </ul>
            <div class="signature-section">
                <div class="signature-box">
                    <p>Bill Issued by: <span id="issuedBy"></span></p>
                    <div class="signature-line">Authorised Signature</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">Customer Signature</div>
                </div>
            </div>
            
            <div class="thank-you">Thank you for choosing Hotel Grand Guardian</div>
        </div>

        <div class="no-print">
            <div id="error" class="error-message"></div>

            <div class="input-group" id="bookingIdGroup">
                <label for="billingId">Billing ID</label>
                <input type="text" id="billingId" placeholder="Enter 4-character billing ID" maxlength="4">
            </div>

            <div class="input-group" id="noOfPaxGroup" style="display: none;">
                <input type="hidden" id="noOfPax" name="no_of_pax">
            </div>

            <div class="input-group" id="contactNoGroup">
                <label for="contactNo">Contact No</label>
                <input type="text" id="contactNo" placeholder="Enter contact number">
            </div>

            <div class="input-group" id="whatsappNoGroup">
                <label for="whatsappNo">WhatsApp No</label>
                <input type="text" id="whatsappNo" placeholder="Enter WhatsApp number">
            </div>

            <div class="input-group" id="emailGroup">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Enter email address">
            </div>

            <div class="input-group" id="ratePerPlateGroup">
                <label for="ratePerPlate">Rate Per Plate (Rs.)</label>
                <input type="number" id="ratePerPlate" placeholder="Enter rate per plate" min="0" step="0.01">
            </div>

            <div class="input-group" id="additionalPlateRateGroup">
                <label for="additionalPlateRate">Additional Plate Rate Per Person (Rs.)</label>
                <input type="number" id="additionalPlateRate" placeholder="Enter additional plate rate" min="0" step="0.01">
            </div>

            <div class="input-group" id="remarksGroup">
                <label for="remarks">Remarks</label>
                <input type="text" id="remarks" placeholder="Enter remarks">
            </div>

            <div class="input-group" id="totalValueGroup">
                <label>Total Value Type & Amount</label>
                <div class="payment-inputs">
                    <select id="totalValue">
                        <option value="" disabled selected>Select value type</option>
                        <option value="Subtotal">Package Value</option>
                        <option value="Hall Charges">Hall Charges</option>
                        <option value="Advance Payment">Advance Payment</option>
                        <option value="Additional Charges">Additional Charges</option>
                    </select>
                    <input type="number" id="totalAmount" placeholder="Enter amount" min="0" step="0.01">
                </div>
            </div>

            <div class="input-group" id="paymentTypeGroup">
                <label>Payment Type & Amount</label>
                <div class="payment-inputs">
                    <select id="paymentType">
                        <option value="" disabled selected>Select payment type</option>
                        <option value="Full Payment">Full Payment</option>
                        <option value="Advance Payment">Advance Payment</option>
                        <option value="Advance Balance">Advance Balance</option>
                        <option value="Balance Payment">Balance Payment</option>
                    </select>
                    <input type="number" id="paymentAmount" placeholder="Enter amount" min="0" step="0.01">
                </div>
            </div>

            <div class="input-group" id="pendingAmountGroup">
                <label for="pendingAmount">Pending Amount (Rs.)</label>
                <input type="number" id="pendingAmount" class="readonly-input" readonly>
            </div>

            <div class="button-group">
                <button id="searchButton">Search</button>
                <button id="saveButton" disabled>Save</button>
                <button id="printButton">Print Receipt</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const billingIdInput = document.getElementById('billingId');
        const searchButton = document.getElementById('searchButton');
        const saveButton = document.getElementById('saveButton');
        const printButton = document.getElementById('printButton');
        const backButton = document.getElementById('backButton');
        const errorDiv = document.getElementById('error');
        const detailsDiv = document.getElementById('details');
        const invoiceNumberDiv = document.getElementById('invoiceNumber');
        const billingDateDiv = document.getElementById('billingDate');
        const paymentSectionDiv = document.getElementById('paymentSection');
        const noOfPaxInput = document.getElementById('noOfPax');
        const contactNoInput = document.getElementById('contactNo');
        const whatsappNoInput = document.getElementById('whatsappNo');
        const emailInput = document.getElementById('email');
        const totalAmountInput = document.getElementById('totalAmount');
        const paymentAmountInput = document.getElementById('paymentAmount');
        const pendingAmountInput = document.getElementById('pendingAmount');
        const ratePerPlateInput = document.getElementById('ratePerPlate');
        const additionalPlateRateInput = document.getElementById('additionalPlateRate');
        const issuedBySpan = document.getElementById('issuedBy');
        
        let currentBookingId = '';

        // Set current date as billing date
        const today = new Date();
        billingDateDiv.textContent = formatDate(today);
        
        // Hide input groups initially except booking ID
        document.querySelectorAll('.input-group').forEach(group => {
            if (group.id !== 'bookingIdGroup') {
                group.style.display = 'none';
            }
        });

        // Back button event listener
        backButton.addEventListener('click', () => {
            window.location.href = 'Backoffice.php';
        });

        // Auto-calculate pending amount
        totalAmountInput.addEventListener('input', calculatePendingAmount);
        paymentAmountInput.addEventListener('input', calculatePendingAmount);
        
        // Auto-calculate total amount from rate per plate and pax
        ratePerPlateInput.addEventListener('input', calculateTotalFromRate);
        
        function calculatePendingAmount() {
            const total = parseFloat(totalAmountInput.value) || 0;
            const payment = parseFloat(paymentAmountInput.value) || 0;
            const pending = total - payment;
            pendingAmountInput.value = pending.toFixed(2);
            updateReceiptPreview();
        }
        
        function calculateTotalFromRate() {
            const rate = parseFloat(ratePerPlateInput.value) || 0;
            const pax = parseInt(noOfPaxInput.value) || 0;
            if (pax > 0) {
                totalAmountInput.value = (rate * pax).toFixed(2);
                calculatePendingAmount();
            }
        }
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }
        
        function updateReceiptPreview() {
            const contactNo = contactNoInput.value;
            const whatsappNo = whatsappNoInput.value;
            const email = emailInput.value;
            const ratePerPlate = ratePerPlateInput.value;
            const additionalPlateRate = additionalPlateRateInput.value;
            const remarks = document.getElementById('remarks').value;
            const totalValueType = document.getElementById('totalValue').value;
            const totalAmount = totalAmountInput.value;
            const paymentType = document.getElementById('paymentType').value;
            const paymentAmount = paymentAmountInput.value;
            const pendingAmount = pendingAmountInput.value;

            // Clear payment section
            paymentSectionDiv.innerHTML = '';

            // Update contact number
            if (contactNo) {
                let contactPara = Array.from(detailsDiv.querySelectorAll('p')).find(p => p.textContent.includes('Contact No:'));
                if (contactPara) contactPara.nextElementSibling.textContent = contactNo;
            }

            // Update WhatsApp number
            if (whatsappNo) {
                let whatsappPara = Array.from(detailsDiv.querySelectorAll('p')).find(p => p.textContent.includes('WhatsApp No:'));
                if (whatsappPara) whatsappPara.nextElementSibling.textContent = whatsappNo;
            }

            // Update email
            if (email) {
                let emailPara = Array.from(detailsDiv.querySelectorAll('p')).find(p => p.textContent.includes('Email:'));
                if (emailPara) emailPara.nextElementSibling.textContent = email;
            }

            // Update rate per plate
            if (ratePerPlate) {
                let ratePara = Array.from(detailsDiv.querySelectorAll('p')).find(p => p.textContent.includes('Rate Per Plate:'));
                if (ratePara) {
                    ratePara.nextElementSibling.textContent = `Rs. ${parseFloat(ratePerPlate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else {
                    const namePara = document.createElement('p');
                    const valuePara = document.createElement('p');
                    namePara.innerHTML = '<strong>Rate Per Plate:</strong>';
                    valuePara.textContent = `Rs. ${parseFloat(ratePerPlate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    detailsDiv.appendChild(namePara);
                    detailsDiv.appendChild(valuePara);
                }
            }

            // Update additional plate rate
            if (additionalPlateRate) {
                let additionalRatePara = Array.from(detailsDiv.querySelectorAll('p')).find(p => p.textContent.includes('Additional Plate Rate:'));
                if (additionalRatePara) {
                    additionalRatePara.nextElementSibling.textContent = `Rs. ${parseFloat(additionalPlateRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else {
                    const namePara = document.createElement('p');
                    const valuePara = document.createElement('p');
                    namePara.innerHTML = '<strong>Additional Plate Rate:</strong>';
                    valuePara.textContent = `Rs. ${parseFloat(additionalPlateRate).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    detailsDiv.appendChild(namePara);
                    detailsDiv.appendChild(valuePara);
                }
            }

            // Update remarks
            if (remarks) {
                let remarksPara = Array.from(detailsDiv.querySelectorAll('p')).find(p => p.textContent.includes('Remarks:'));
                if (remarksPara) {
                    remarksPara.nextElementSibling.textContent = remarks;
                } else {
                    const namePara = document.createElement('p');
                    const valuePara = document.createElement('p');
                    namePara.innerHTML = '<strong>Remarks:</strong>';
                    valuePara.textContent = remarks;
                    detailsDiv.appendChild(namePara);
                    detailsDiv.appendChild(valuePara);
                }
            }

            // Create payment summary
            if (totalValueType && totalAmount || paymentType && paymentAmount || pendingAmount) {
                const paymentSummary = document.createElement('div');
                paymentSummary.className = 'payment-summary';

                if (totalValueType && totalAmount) {
                    const totalRow = document.createElement('div');
                    totalRow.className = 'payment-row total';
                    totalRow.innerHTML = `
                        <span>${totalValueType}:</span>
                        <span>Rs. ${parseFloat(totalAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    `;
                    paymentSummary.appendChild(totalRow);
                }

                if (paymentType && paymentAmount) {
                    const paymentRow = document.createElement('div');
                    paymentRow.className = 'payment-row';
                    paymentRow.innerHTML = `
                        <span>${paymentType === 'Full Payment' ? 'Full Payment:' : paymentType === 'Advance Payment' ? 'Advance Payment:' : paymentType === 'Advance Balance' ? 'Advance Balance:' : 'Balance Payment:'}</span>
                        <span>Rs. ${parseFloat(paymentAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    `;
                    paymentSummary.appendChild(paymentRow);
                }

                if (pendingAmount) {
                    const pendingRow = document.createElement('div');
                    pendingRow.className = 'payment-row pending';
                    pendingRow.innerHTML = `
                        <span>Pending Amount:</span>
                        <span>Rs. ${parseFloat(pendingAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    `;
                    paymentSummary.appendChild(pendingRow);
                }

                paymentSectionDiv.appendChild(paymentSummary);
            }

            // Enable save button if valid input
            saveButton.disabled = !(totalValueType && totalAmount && paymentType && paymentAmount);
        }

        // Update preview on input change
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('input', updateReceiptPreview);
        });
        
        // Print button event listener
        printButton.addEventListener('click', async () => {
            // Disable buttons to prevent multiple clicks
            printButton.disabled = true;
            saveButton.disabled = true;

            // Check if required fields are filled
            const totalValueType = document.getElementById('totalValue').value;
            const totalAmount = totalAmountInput.value;
            const paymentType = document.getElementById('paymentType').value;
            const paymentAmount = paymentAmountInput.value;

            if (!totalValueType || !totalAmount || !paymentType || !paymentAmount) {
                showError('Please fill all required fields before printing');
                printButton.disabled = false;
                saveButton.disabled = false;
                return;
            }

            try {
                // Save payment and get invoice number
                const invoiceNumber = await savePayment(false); // Pass false to prevent form reset
                invoiceNumberDiv.textContent = `${invoiceNumber}`; // Update invoice number in UI

                // Open print dialog
                window.print();
            } catch (error) {
                showError('Error saving payment: ' + error.message);
            } finally {
                // Re-enable buttons
                printButton.disabled = false;
                saveButton.disabled = false;
            }
        });

        // Search Button Click Handler
        searchButton.addEventListener('click', function() {
            const billingId = billingIdInput.value.trim().toUpperCase();
            if (!billingId || billingId.length !== 4) {
                showError('Please enter a valid 4-character billing ID');
                return;
            }

            currentBookingId = billingId;
            fetchBookingDetails(billingId);
        });

        function fetchBookingDetails(bookingReference) {
            // Validate booking reference
            if (!bookingReference || bookingReference.length !== 4) {
                showError('Please enter a valid 4-character booking ID');
                return;
            }

            // Show loading state
            searchButton.disabled = true;
            searchButton.textContent = 'Searching...';

            fetch(`api/get_booking_details.php?reference=${bookingReference}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        displayBookingDetails(data);
                        showSuccess('Booking details loaded successfully');
                        
                        // Show input groups
                        document.querySelectorAll('.input-group').forEach(group => {
                            if (group.id !== 'customFieldsGroup') {
                                group.style.display = 'block';
                            }
                        });
                        
                        saveButton.disabled = true;
                        printButton.disabled = false;
                        searchButton.textContent = 'Update Form';
                    }
                })
                .catch(error => {
                    showError('Error fetching booking details: ' + error.message);
                })
                .finally(() => {
                    searchButton.disabled = false;
                    searchButton.textContent = searchButton.textContent === 'Update Form' ? 'Update Form' : 'Search';
                });
        }

        function displayBookingDetails(booking) {
            window.booking = booking;
            let contactNumbers = booking.contact_no1 || '';
            if (booking.contact_no2) {
                contactNumbers += contactNumbers ? ` / ${booking.contact_no2}` : booking.contact_no2;
            }
            contactNoInput.value = contactNumbers || '';
            
            // Format address
            const address = booking.groom_address || booking.bride_address || 'Address not specified';

            // Format booking date
            const bookingDate = booking.booking_date
                ? formatDate(new Date(booking.booking_date))
                : 'Date not specified';

            // Set number of pax
            noOfPaxInput.value = booking.no_of_pax || '';
            
            // Populate details
            detailsDiv.innerHTML = `
                <p><strong>Customer Name:</strong></p>
                <p>${booking.full_name || 'Not provided'}</p>
                <p><strong>Couple Name:</strong></p>
                <p>${booking.couple_name || 'Not provided'}</p>
                <p><strong>Contact No:</strong></p>
                <p>${contactNoInput.value || 'Not provided'}</p>
                <p><strong>WhatsApp No:</strong></p>
                <p>${whatsappNoInput.value || 'Not provided'}</p>
                <p><strong>Email:</strong></p>
                <p>${emailInput.value || 'Not provided'}</p>
                <p><strong>Address:</strong></p>
                <p>${address}</p>
                <p><strong>Date of Event:</strong></p>
                <p>${bookingDate}</p>
                <p><strong>Event Type:</strong></p>
                <p>${booking.function_type || 'Not specified'}</p>
                <p><strong>Venue:</strong></p>
                <p>${booking.venue || 'Not specified'}</p>
                <p><strong>Number of Pax:</strong></p>
                <p>${booking.no_of_pax || 'Not specified'}</p>
                <p><strong>Time:</strong></p>
                <p>${booking.day_or_night || 'Not specified'}</p>
            `;
            
            invoiceNumberDiv.textContent = '(Will be generated on save)';
            paymentSectionDiv.innerHTML = '';
            searchButton.textContent = 'Update Form';
            updateReceiptPreview();
        }

        async function savePayment(resetForm = true) {
    const paymentData = {
        booking_reference: currentBookingId,
        contact_no: contactNoInput.value,
        whatsapp_no: whatsappNoInput.value,
        email: emailInput.value,
        rate_per_plate: ratePerPlateInput.value,
        additional_plate_rate: additionalPlateRateInput.value,
        remarks: document.getElementById('remarks').value,
        value_type: document.getElementById('totalValue').value,
        total_amount: totalAmountInput.value,
        payment_type: document.getElementById('paymentType').value,
        payment_amount: paymentAmountInput.value,
        pending_amount: pendingAmountInput.value,
        no_of_pax: noOfPaxInput.value,
        day_or_night: booking?.day_or_night || null  // ADDED THIS LINE
    };
            
            const response = await fetch('api/save_payment.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(paymentData)
            });
            const data = await response.json();
            
            if (data.success) {
                if (resetForm) {
                    // Only reset form if explicitly requested
                    contactNoInput.value = '';
                    whatsappNoInput.value = '';
                    emailInput.value = '';
                    ratePerPlateInput.value = '';
                    additionalPlateRateInput.value = '';
                    document.getElementById('remarks').value = '';
                    document.getElementById('totalValue').value = '';
                    totalAmountInput.value = '';
                    document.getElementById('paymentType').value = '';
                    paymentAmountInput.value = '';
                    pendingAmountInput.value = '';
                    saveButton.disabled = true;
                    updateReceiptPreview();
                }
                showSuccess('Payment saved successfully');
                return data.invoice_number; // Return invoice number
            } else {
                throw new Error(data.error || 'Error saving payment');
            }
        }

        function fetchCurrentUser() {
            fetch('api/get_current_user.php')
                .then(response => response.json())
                .then(data => {
                    if (data.username) {
                        issuedBySpan.textContent = data.username;
                    }
                })
                .catch(error => {
                    console.error('Error fetching current user:', error);
                    issuedBySpan.textContent = 'Admin';
                });
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.className = 'error-message error';
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            errorDiv.textContent = message;
            errorDiv.className = 'error-message success';
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 3000);
        }

        // Fetch current user when page loads
        fetchCurrentUser();
    });
    </script>
</body>
</html>